trigger:
  branches:
    include:
    - '*'

variables:
  buildConfiguration: 'Release'

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: build
    jobs:
    - job: 'api_build_and_test'
      displayName: 'API Build & Test'
      steps:
      - task: fizzcode-discordhook@1
        inputs:
          DiscordChannelID: '964192752814420018'
          DiscordToken: 'ep33yQ0CzIFKKiN0Jmq-hB0vBO06w1Ac1Tkid6dB3v57Ru9WCmPDzo2k3su5cvk2fksR'
          Title: 'Pushed to $(Build.SourceBranchName)'
          Message: '$(Build.SourceVersionMessage)'
      - template: Pipelines/Api/Templates/build-test.yml
        parameters:
          buildConfiguration:  $(buildConfiguration)
          projectsFilter: '**/*.csproj'
          publishArtifactFilter: '**/*.csproj'
          testProjectsFilter: '**/*Tests.csproj'
          runImplementationTests: 'true'
          runUnitTests: 'true'
          runIntegrationTests: ${{ or(contains(variables['build.sourceBranch'], 'development'), contains(variables['build.sourceBranch'], 'main')) }}
          runSmokeTests: ${{ contains(variables['build.sourceBranch'], 'main') }}
          publishArtifact: ${{ or(contains(variables['build.sourceBranch'], 'development'), contains(variables['build.sourceBranch'], 'main')) }}
      - task: fizzcode-discordhook@1
        inputs:
          DiscordChannelID: '964192752814420018'
          DiscordToken: 'ep33yQ0CzIFKKiN0Jmq-hB0vBO06w1Ac1Tkid6dB3v57Ru9WCmPDzo2k3su5cvk2fksR'
          Title: '$Build $(Build.BuildNumber) succeeded ($(Build.Reason))'
          Message: 'Succeeded at API build & testing'

  - stage: deploy_dev
    dependsOn: build
    condition: and(succeeded(), contains(variables['build.sourceBranch'], 'development'))
    displayName: 'Deploy API'
    jobs:
      - job:  deploy
        displayName: 'Deploy API'
        steps:
        - task: DownloadBuildArtifacts@0
          displayName: 'Download Artifacts'
          inputs:
            buildType: 'current'
            downloadType: 'single'
            artifactName: 'drop'
            downloadPath: '$(System.ArtifactsDirectory)'
        - task: AzureRmWebAppDeployment@4
          displayName: 'Deploy API'
          inputs:
            ConnectionType: 'AzureRM'
            azureSubscription: 'sc-zoo-dev'
            appType: 'webApp'
            WebAppName: 'app-zoo-dev'
            ResourceGroupName: 'rg-zoo-dev'
            StartupCommand: 'dotnet AspNetCore.dll'
            packageForLinux: '$(System.ArtifactsDirectory)/drop/AspNetCore.zip'
        - task: fizzcode-discordhook@1
          inputs:
            DiscordChannelID: '964192752814420018'
            DiscordToken: 'ep33yQ0CzIFKKiN0Jmq-hB0vBO06w1Ac1Tkid6dB3v57Ru9WCmPDzo2k3su5cvk2fksR'
            Title: 'Deployment'
            Message: 'Deployed $Build $(Build.BuildNumber) to development'
